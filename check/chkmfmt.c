
#include <maug.h>

#include <check.h>

uint8_t gc_check_rle[] = {
   0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00,
   0x00, 0x18, 0xff, 0x00, 0x08, 0x77, 0x7f, 0xff, 0xff, 0x00, 0x00,
   0x16, 0xff, 0x00, 0x0a, 0xf7, 0xcc, 0xc7, 0xff, 0xff, 0x00, 0x00,
   0x00, 0x16, 0xff, 0x00, 0x0a, 0xf7, 0xcc, 0xc7, 0xff, 0xff, 0x00,
   0x00, 0x00, 0x16, 0xff, 0x00, 0x0a, 0xf7, 0xcc, 0xc7, 0xff, 0xff,
   0x00, 0x00, 0x00, 0x18, 0xff, 0x00, 0x08, 0x77, 0x7f, 0xff, 0xff,
   0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20,
   0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   0x0e, 0xff, 0x02, 0x77, 0x02, 0x77, 0x0e, 0xff, 0x00, 0x00, 0x0e,
   0xff, 0x02, 0x79, 0x02, 0x97, 0x0e, 0xff, 0x00, 0x00, 0x0e, 0xff,
   0x02, 0x79, 0x02, 0x97, 0x0e, 0xff, 0x00, 0x00, 0x0e, 0xff, 0x02,
   0x77, 0x02, 0x77, 0x0e, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00,
   0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x00, 0x08,
   0xff, 0xff, 0xf7, 0x77, 0x18, 0xff, 0x00, 0x00, 0x00, 0x0a, 0xff,
   0xff, 0x7c, 0xcc, 0x7f, 0x00, 0x16, 0xff, 0x00, 0x00, 0x00, 0x0a,
   0xff, 0xff, 0x7c, 0xcc, 0x7f, 0x00, 0x16, 0xff, 0x00, 0x00, 0x00,
   0x0a, 0xff, 0xff, 0x7c, 0xcc, 0x7f, 0x00, 0x16, 0xff, 0x00, 0x00,
   0x00, 0x08, 0xff, 0xff, 0xf7, 0x77, 0x18, 0xff, 0x00, 0x00, 0x20,
   0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   0x20, 0xff, 0x00, 0x01 };

uint8_t gc_check_rle_raw[] = {
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0x77, 0x7f, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xcc,
   0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xf7, 0xcc, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xcc, 0xc7,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x77, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x77, 0x77, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0x79, 0x97, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0x79, 0x97, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x77,
   0x77, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x77, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0x7c, 0xcc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7c, 0xcc, 0x7f, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0x7c, 0xcc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x77, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff };

START_TEST( test_mfmt_decode_rle ) {
   mfile_t check_rle_file;
   MAUG_MHANDLE check_rle_out_h = (MAUG_MHANDLE)NULL;
   uint8_t* check_rle_out = NULL;
   MERROR_RETVAL retval = MERROR_OK;
   size_t i = 0;

   check_rle_out_h = maug_malloc( 1, sizeof( gc_check_rle_raw ) );
   mfile_lock_buffer( gc_check_rle, &check_rle_file );

   retval = mfmt_decode_rle(
      &check_rle_file, 0, sizeof( gc_check_rle ),
      check_rle_out_h, sizeof( gc_check_rle_raw ), MFMT_DECOMP_FLAG_4BIT );

   ck_assert_uint_eq( retval, MERROR_OK );

   maug_mlock( check_rle_out_h, check_rle_out );

   for( i = 0 ; sizeof( gc_check_rle_raw ) > i ; i++ ) {
      printf( SIZE_T_FMT "\n", i );
      ck_assert_uint_eq( check_rle_out[i], gc_check_rle_raw[i] );
   }

   maug_munlock( check_rle_out_h, check_rle_out );
   maug_mfree( check_rle_out_h );
}
END_TEST

Suite* mfmt_suite( void ) {
   Suite* s;
   TCase* tc_decode;

   s = suite_create( "mfmt" );

   tc_decode = tcase_create( "Decode" );

   tcase_add_test( tc_decode, test_mfmt_decode_rle );

   suite_add_tcase( s, tc_decode );

   return s;
}

