
#include <maug.h>

#include <check.h>

uint8_t gc_check_rle[] = {
   /*   0 */ 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff,
   /*  10 */ 0x00, 0x00, 0x18, 0xff, 0x00, 0x08, 0x77, 0x7f, 0xff, 0xff,
   /*  20 */ 0x00, 0x00, 0x16, 0xff, 0x00, 0x0a, 0xf7, 0xcc, 0xc7, 0xff,
   /*  30 */ 0xff, 0x00, 0x00, 0x00, 0x16, 0xff, 0x00, 0x0a, 0xf7, 0xcc,
   /*  40 */ 0xc7, 0xff, 0xff, 0x00, 0x00, 0x00, 0x16, 0xff, 0x00, 0x0a,
   /*  50 */ 0xf7, 0xcc, 0xc7, 0xff, 0xff, 0x00, 0x00, 0x00, 0x18, 0xff,
   /*  60 */ 0x00, 0x08, 0x77, 0x7f, 0xff, 0xff, 0x00, 0x00, 0x20, 0xff,
   /*  70 */ 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   /*  80 */ 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x0e, 0xff,
   /*  90 */ 0x02, 0x77, 0x02, 0x77, 0x0e, 0xff, 0x00, 0x00, 0x0e, 0xff,
   /* 100 */ 0x02, 0x79, 0x02, 0x97, 0x0e, 0xff, 0x00, 0x00, 0x0e, 0xff,
   /* 110 */ 0x02, 0x79, 0x02, 0x97, 0x0e, 0xff, 0x00, 0x00, 0x0e, 0xff,
   /* 120 */ 0x02, 0x77, 0x02, 0x77, 0x0e, 0xff, 0x00, 0x00, 0x20, 0xff,
   /* 130 */ 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   /* 140 */ 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff,
   /* 150 */ 0x00, 0x00, 0x00, 0x08, 0xff, 0xff, 0xf7, 0x77, 0x18, 0xff,
   /* 160 */ 0x00, 0x00, 0x00, 0x0a, 0xff, 0xff, 0x7c, 0xcc, 0x7f, 0x00,
   /* 170 */ 0x16, 0xff, 0x00, 0x00, 0x00, 0x0a, 0xff, 0xff, 0x7c, 0xcc,
   /* 180 */ 0x7f, 0x00, 0x16, 0xff, 0x00, 0x00, 0x00, 0x0a, 0xff, 0xff,
   /* 190 */ 0x7c, 0xcc, 0x7f, 0x00, 0x16, 0xff, 0x00, 0x00, 0x00, 0x08,
   /* 200 */ 0xff, 0xff, 0xf7, 0x77, 0x18, 0xff, 0x00, 0x00, 0x20, 0xff,
   /* 210 */ 0x00, 0x00, 0x20, 0xff, 0x00, 0x00, 0x20, 0xff, 0x00, 0x00,
   /* 220 */ 0x20, 0xff, 0x00, 0x01 };

uint8_t gc_check_rle_raw[] = {
   /*   0 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  10 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  20 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  30 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  40 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  50 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  60 */ 0x77, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  70 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xcc, 0xc7, 0xff, 0xff,
   /*  80 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /*  90 */ 0xff, 0xf7, 0xcc, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 100 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xcc, 0xc7,
   /* 110 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 120 */ 0xff, 0xff, 0xff, 0xff, 0x77, 0x7f, 0xff, 0xff, 0xff, 0xff,
   /* 130 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 140 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 150 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 160 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 170 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 180 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 190 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 200 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 210 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0x77, 0x77, 0xff, 0xff, 0xff,
   /* 220 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 230 */ 0xff, 0x79, 0x97, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 240 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x79, 0x97, 0xff,
   /* 250 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 260 */ 0xff, 0xff, 0xff, 0x77, 0x77, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 270 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 280 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 290 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 300 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 310 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 320 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 330 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 340 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 350 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 360 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 370 */ 0xf7, 0x77, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 380 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7c, 0xcc, 0x7f, 0xff,
   /* 390 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 400 */ 0xff, 0xff, 0x7c, 0xcc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 410 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7c, 0xcc,
   /* 420 */ 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 430 */ 0xff, 0xff, 0xff, 0xff, 0xf7, 0x77, 0xff, 0xff, 0xff, 0xff,
   /* 440 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 450 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 460 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 470 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 480 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 490 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 500 */ 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   /* 510 */ 0xff, 0xff };

START_TEST( test_mfmt_decode_rle ) {
   mfile_t check_rle_file;
   MAUG_MHANDLE check_rle_out_h = (MAUG_MHANDLE)NULL;
   uint8_t* check_rle_out = NULL;
   MERROR_RETVAL retval = MERROR_OK;
   size_t i = 0;

   check_rle_out_h = maug_malloc( 1, sizeof( gc_check_rle_raw ) );
   mfile_lock_buffer( gc_check_rle, &check_rle_file );

   retval = mfmt_decode_rle(
      &check_rle_file, 0, sizeof( gc_check_rle ), 32,
      check_rle_out_h, sizeof( gc_check_rle_raw ), MFMT_DECOMP_FLAG_4BIT );

   ck_assert_uint_eq( retval, MERROR_OK );

   maug_mlock( check_rle_out_h, check_rle_out );

   for( i = 0 ; sizeof( gc_check_rle_raw ) > i ; i++ ) {
      debug_printf( 1, "i: " SIZE_T_FMT " (of " SIZE_T_FMT ") test: "
         "0x%02x good: 0x%02x",
         i, sizeof( gc_check_rle_raw ),
         check_rle_out[i], gc_check_rle_raw[i] );
      ck_assert_uint_eq( check_rle_out[i], gc_check_rle_raw[i] );
   }

   maug_munlock( check_rle_out_h, check_rle_out );
   maug_mfree( check_rle_out_h );
}
END_TEST

Suite* mfmt_suite( void ) {
   Suite* s;
   TCase* tc_decode;

   s = suite_create( "mfmt" );

   tc_decode = tcase_create( "Decode" );

   tcase_add_test( tc_decode, test_mfmt_decode_rle );

   suite_add_tcase( s, tc_decode );

   return s;
}

